<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Post-Op AI Monitor</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: #f5f7fa;
      color: #1a1a1a;
      line-height: 1.35;
      padding-bottom: 40px;
    }

    /* Header */
    .header {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1a1a1a;
    }
    .nav-links {
      display: flex;
      gap: 8px;
      margin-left: 24px;
    }
    .nav-link {
      padding: 8px 12px;
      text-decoration: none;
      color: #666;
      border-radius: 6px;
      transition: all 0.15s;
      font-size: 0.9rem;
      cursor: pointer;
      background: transparent;
      border: 0;
    }
    .nav-link:hover {
      background: #f0f0f0;
      color: #1a1a1a;
    }
    .nav-link.active {
      background: #2563eb;
      color: #fff;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .btn-add-patient {
      background: #10b981;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 0.9rem;
    }

    /* Tab Content */
    .tab-content {
      display: none;
      padding: 24px;
      max-width: 1200px;
      margin: 20px auto;
    }
    .tab-content.active {
      display: block;
    }

    /* Dashboard Styles */
    .risk-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    .risk-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      position: relative;
      min-height: 96px;
    }
    .risk-card.high { border-left: 4px solid #ef4444; }
    .risk-card.medium { border-left: 4px solid #f59e0b; }
    .risk-card.low { border-left: 4px solid #10b981; }
    .risk-card-title {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 8px;
    }
    .risk-card-count {
      font-size: 2.25rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .risk-card-status {
      font-size: 0.85rem;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .risk-card-icon {
      position: absolute;
      top: 18px;
      right: 16px;
      font-size: 1.4rem;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }
    @media (max-width: 900px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    .patient-list-section, .alerts-panel-section, .alert-engine-panel {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .sort-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .sort-btn {
      padding: 6px 12px;
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .sort-btn.active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .patient-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    .patient-table th {
      text-align: left;
      padding: 12px;
      font-size: 0.85rem;
      color: #666;
      border-bottom: 2px solid #e0e0e0;
      font-weight: 700;
    }
    .patient-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.95rem;
    }
    .risk-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }
    .risk-badge.high { background: #fee2e2; color: #dc2626; }
    .risk-badge.medium { background: #fef3c7; color: #d97706; }
    .risk-badge.low { background: #d1fae5; color: #059669; }
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .btn-view-details {
      padding: 6px 12px;
      background: #f3f4f6;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-view-details:hover { background: #e5e7eb; }

    .alerts-panel-section { max-height: 600px; overflow-y: auto; }

    .alert-item {
      padding: 12px;
      border-left: 4px solid;
      border-radius: 4px;
      margin-bottom: 12px;
      background: #f9fafb;
    }
    .alert-item.emergency { border-left-color: #ef4444; }
    .alert-item.priority { border-left-color: #f59e0b; }
    .alert-item.normal { border-left-color: #10b981; }
    .alert-level { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
    .alert-reason { font-size: 0.85rem; color: #666; margin-bottom: 6px; }
    .alert-time { font-size: 0.8rem; color: #999; display: flex; align-items: center; gap: 6px; }

    /* Post Op Score Styles */
    .upload-section {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .upload-form { flex: 1; min-width: 320px; }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95rem;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    /* vitals - adjusted to fit 5 inputs */
    .vitals-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    @media (max-width: 900px) {
      .form-row { grid-template-columns: 1fr; }
      .vitals-row { grid-template-columns: repeat(2, 1fr); }
      .file-upload-section { width: 100%; }
    }

    .file-upload-section { width: 260px; min-width: 220px; }
    .btn-analyze {
      width: 100%;
      padding: 10px;
      background: #0a7a3a;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 12px;
    }
    .btn-clear {
      width: 100%;
      padding: 8px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 8px;
    }
    .loading {
      margin: 14px 0;
      padding: 8px;
      background: #fffbeb;
      border: 1px solid #f5e1b8;
      border-radius: 6px;
    }
    .hidden { display: none; }
    .result-section {
      margin-top: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    /* Alert Engine header */
    .alert-engine-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:12px; flex-wrap:wrap;}
    .alert-counters { display:flex; gap:20px; align-items:center; }
    .counter-item { text-align:center; min-width:80px; }
    .counter-value { font-size:1.25rem; font-weight:700; margin-bottom:4px; }
    .counter-value.emergency { color: #ef4444; }
    .counter-value.priority { color: #f59e0b; }
    .counter-value.normal { color: #10b981; }
    .counter-label { font-size:0.85rem; color:#666; }

    .alert-actions { margin-top: 12px; display:flex; gap:8px; justify-content:flex-end; }
    .btn-refresh, .btn-clear-alerts { padding:6px 12px; border:1px solid #ddd; background:#fff; border-radius:6px; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="header-title">🩺 Post-Op AI Monitor</div>
      <nav class="nav-links" role="navigation" aria-label="Main">
        <button class="nav-link active" data-tab="dashboard">Dashboard</button>
        <button class="nav-link" data-tab="postop">Post Op Score</button>
        <button class="nav-link" data-tab="alerts">Alert Engine</button>
      </nav>
    </div>
    <div class="header-right">
      <button class="btn-add-patient" onclick="showAddPatient()">+ Add Patient</button>
      <div class="user-info" aria-hidden="true">
        <span>👤</span>
        <span>nurse</span>
      </div>
    </div>
  </div>

  <!-- Dashboard Tab -->
  <div id="dashboard-tab" class="tab-content active">
    <!-- Risk Summary Cards -->
    <div class="risk-cards">
      <div class="risk-card high" aria-live="polite">
        <div class="risk-card-title">High-Risk Patients</div>
        <div class="risk-card-count" id="high-risk-count">0</div>
        <div class="risk-card-status">
          <span id="high-risk-trend">0 new since yesterday</span>
          <span>📈</span>
        </div>
        <div class="risk-card-icon">⚠️</div>
      </div>
      <div class="risk-card medium">
        <div class="risk-card-title">Medium Risk</div>
        <div class="risk-card-count" id="medium-risk-count">0</div>
        <div class="risk-card-status">
          <span>Monitoring required</span>
          <span>🕐</span>
        </div>
        <div class="risk-card-icon">⚠️</div>
      </div>
      <div class="risk-card low">
        <div class="risk-card-title">Low Risk</div>
        <div class="risk-card-count" id="low-risk-count">0</div>
        <div class="risk-card-status">
          <span>Recovering well</span>
          <span>✓</span>
        </div>
        <div class="risk-card-icon">✓</div>
      </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Patient List -->
      <div>
        <div class="patient-list-section">
          <div class="section-title">Patient List</div>
          <div class="sort-buttons" role="tablist" aria-label="Sort patients">
            <button class="sort-btn active" data-sort="risk">Sort by Risk</button>
            <button class="sort-btn" data-sort="name">Sort by Name</button>
          </div>
          <table class="patient-table" aria-describedby="patient-list">
            <thead>
              <tr>
                <th>Patient</th>
                <th>Risk</th>
                <th>Last Update</th>
                <th>Alerts</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="patient-list-body">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Real-Time Alerts Panel -->
      <div>
        <div class="alerts-panel-section">
          <div class="section-title">Real-Time Alerts</div>
          <div id="dashboard-alerts-list" aria-live="polite">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Post Op Score Tab -->
  <div id="postop-tab" class="tab-content">
    <h2 style="margin-bottom: 8px;">Post-Operative Risk Scoring</h2>
    <p class="subtitle" style="color: #666; margin-bottom: 12px;">Upload a discharge summary or enter patient info / vitals to get a risk prediction within 72 hours.</p>

    <section class="upload-section" aria-label="Post op form">
      <div class="upload-form" role="form">
        <div class="form-group">
          <label for="patientId">Patient ID</label>
          <input id="patientId" type="text" placeholder="L-10238" />
        </div>

        <div class="form-group">
          <label>Name / Age / Sex</label>
          <div class="form-row">
            <input id="patientName" type="text" placeholder="Name" />
            <input id="patientAge" type="number" placeholder="Age" min="0" />
            <select id="patientSex" aria-label="Sex">
              <option value="">Sex</option>
              <option>F</option>
              <option>M</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Manual vitals (optional)</label>
          <div class="vitals-row">
            <input id="tempManual" placeholder="Temp (e.g. 98.2 F or 36.7 C)" />
            <input id="hrManual" type="number" placeholder="HR bpm" min="0" />
            <input id="rrManual" type="number" placeholder="RR /min" min="0" />
            <input id="bpManual" placeholder="BP e.g. 118/76" />
            <input id="spo2Manual" type="number" placeholder="SpO2 %" min="0" max="100" />
          </div>
        </div>
      </div>

      <div class="file-upload-section">
        <div class="form-group">
          <label for="fileInput">Upload file</label>
          <input id="fileInput" type="file" accept=".pdf,.doc,.docx,.txt" style="width: 100%; padding: 6px;" />
        </div>
        <button id="uploadBtn" class="btn-analyze" type="button">Analyze</button>
        <button id="clearBtn" class="btn-clear" type="button">Clear</button>
      </div>
    </section>

    <div id="loading" class="hidden loading" role="status">Analyzing… please wait</div>
    <section id="result" class="result-section hidden" aria-live="polite"></section>
  </div>

  <!-- Alert Engine Tab -->
  <div id="alerts-tab" class="tab-content">
    <h2 style="margin-bottom: 10px;">Alert Engine</h2>

    <div class="alert-engine-header">
      <div>
        <h3 style="margin: 0; font-size: 1.05rem;">Real-Time Alerts</h3>
        <small style="color: #666;">Live feed of critical patient alerts</small>
      </div>
      <div class="alert-counters">
        <div class="counter-item">
          <div class="counter-value emergency" id="countEmergency">0</div>
          <div class="counter-label">Emergency</div>
        </div>
        <div class="counter-item">
          <div class="counter-value priority" id="countPriority">0</div>
          <div class="counter-label">Priority</div>
        </div>
        <div class="counter-item">
          <div class="counter-value normal" id="countNormal">0</div>
          <div class="counter-label">Normal</div>
        </div>
      </div>
    </div>

    <div class="alert-engine-panel">
      <div id="alertsPanel" aria-live="polite"></div>
      <div class="alert-actions">
        <button id="refreshAlertsBtn" class="btn-refresh" type="button">Refresh</button>
        <button id="clearAlertsBtn" class="btn-clear-alerts" type="button">Clear</button>
      </div>
    </div>
  </div>

  <!-- Optional external libs (if used by your project) -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="/script.js"></script>
  <script src="/dashboard.js"></script>
  <script src="/alert.js"></script>

  <!-- Inline behaviours (safe defaults if external scripts don't exist) -->
  <script>
    // tab switching
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          const tabName = link.getAttribute('data-tab');
          switchTab(tabName);
        });
      });

      // sort buttons behaviour
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          // do a basic resort (local demo)
          if (btn.dataset.sort === 'name') loadDashboard('name');
          else loadDashboard('risk');
        });
      });

      // Attach actions
      document.getElementById('uploadBtn').addEventListener('click', analyzePatient);
      document.getElementById('clearBtn').addEventListener('click', clearForm);
      document.getElementById('refreshAlertsBtn').addEventListener('click', loadAlerts);
      document.getElementById('clearAlertsBtn').addEventListener('click', clearAlerts);

      // If patientId in URL, open postop
      const urlParams = new URLSearchParams(window.location.search);
      const pid = urlParams.get('patientId');
      if (pid) {
        switchTab('postop');
        document.getElementById('patientId').value = pid;
      } else {
        loadDashboard();
      }
    });

    function switchTab(tabName) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.toggle('active', link.getAttribute('data-tab') === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.toggle('active', tab.id === tabName + '-tab' || tab.id === tabName + '-tab' ? true : tab.id === tabName + '-tab');
      });

      // explicit mapping since our ids are e.g. "dashboard-tab"
      document.getElementById('dashboard-tab').classList.toggle('active', tabName === 'dashboard');
      document.getElementById('postop-tab').classList.toggle('active', tabName === 'postop');
      document.getElementById('alerts-tab').classList.toggle('active', tabName === 'alerts');

      if (tabName === 'dashboard') loadDashboard();
      if (tabName === 'alerts') loadAlerts();
    }

    function showAddPatient() {
      switchTab('postop');
      clearForm();
      document.getElementById('patientName').focus();
    }

    // Demo data (replace with real API calls)
    const demoPatients = [
      { id: 'L-10238', name: 'Anita Sharma', risk: 'high', lastUpdate: '2025-11-18 10:22', alerts: 3, status: 'Needs review' },
      { id: 'L-10239', name: 'Ramesh Kumar', risk: 'medium', lastUpdate: '2025-11-18 09:55', alerts: 1, status: 'Monitor' },
      { id: 'L-10240', name: 'Saira Bano', risk: 'low', lastUpdate: '2025-11-17 18:12', alerts: 0, status: 'Stable' }
    ];

    const demoAlerts = [
      { level: 'emergency', patient: 'Anita Sharma', reason: 'HR 140 bpm', time: '2025-11-18 10:21' },
      { level: 'priority',  patient: 'Ramesh Kumar', reason: 'SpO2 90%', time: '2025-11-18 09:50' },
      { level: 'normal',    patient: 'Saira Bano', reason: 'High temp 99.5 F', time: '2025-11-17 18:10' }
    ];

    function loadDashboard(sortBy='risk') {
      // Populate counts
      const counts = { high: 0, medium: 0, low: 0 };
      demoPatients.forEach(p => counts[p.risk] += 1);
      document.getElementById('high-risk-count').textContent = counts.high;
      document.getElementById('medium-risk-count').textContent = counts.medium;
      document.getElementById('low-risk-count').textContent = counts.low;
      document.getElementById('high-risk-trend').textContent = `${Math.max(0, counts.high - 0)} new since yesterday`;

      // Populate patient list
      const tbody = document.getElementById('patient-list-body');
      tbody.innerHTML = '';
      const list = [...demoPatients];
      if (sortBy === 'name') list.sort((a,b) => a.name.localeCompare(b.name));
      else list.sort((a,b) => {
        const priority = { 'high': 0, 'medium': 1, 'low': 2 };
        return priority[a.risk] - priority[b.risk];
      });

      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.name}<div style="color:#999;font-size:0.85rem">${p.id}</div></td>
          <td><span class="risk-badge ${p.risk}">${p.risk.toUpperCase()}</span></td>
          <td>${p.lastUpdate}</td>
          <td>${p.alerts}</td>
          <td><span class="status-badge ${p.status === 'Needs review' ? 'needs-review' : (p.status === 'Monitor' ? 'monitor' : 'stable') }">${p.status}</span></td>
          <td><button class="btn-view-details" onclick="goToPostop('${p.id}')">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // dashboard alerts
      const dashAlerts = document.getElementById('dashboard-alerts-list');
      dashAlerts.innerHTML = '';
      demoAlerts.slice(0,3).forEach(a => {
        const div = document.createElement('div');
        div.className = `alert-item ${a.level}`;
        div.innerHTML = `<div class="alert-level">${a.level.toUpperCase()}</div><div class="alert-reason">${a.reason}</div><div class="alert-patient" style="color:#666">${a.patient}</div><div class="alert-time">${a.time}</div>`;
        dashAlerts.appendChild(div);
      });
    }

    function goToPostop(patientId) {
      // navigate with patientId param
      window.history.replaceState({}, '', '?patientId=' + encodeURIComponent(patientId));
      switchTab('postop');
      const pidInput = document.getElementById('patientId');
      if (pidInput) pidInput.value = patientId;
    }

    // Simple analyze flow (replace with real analysis call)
    function analyzePatient() {
      const pid = document.getElementById('patientId').value || 'Unknown';
      const name = document.getElementById('patientName').value || 'Unknown';
      // show loading
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      loading.classList.remove('hidden');
      result.classList.add('hidden');
      result.innerHTML = '';

      // fake async work (demo)
      setTimeout(() => {
        loading.classList.add('hidden');
        result.classList.remove('hidden');
        // simple rule-based demo
        const hr = Number(document.getElementById('hrManual').value) || null;
        const spo2 = Number(document.getElementById('spo2Manual').value) || null;
        let risk = 'low';
        if ((hr && hr > 120) || (spo2 && spo2 < 92)) risk = 'high';
        else if ((hr && hr > 100) || (spo2 && spo2 < 95)) risk = 'medium';

        result.innerHTML = `
          <strong>Patient:</strong> ${name} (${pid})<br>
          <strong>Predicted risk (72h):</strong> <span class="risk-badge ${risk}">${risk.toUpperCase()}</span><br>
          <div style="margin-top:10px;color:#555">This is a demo prediction. Replace with your server-side model or API call to produce real predictions.</div>
        `;

        // update demoPatients if id exists
        const pIndex = demoPatients.findIndex(p => p.id === pid);
        const now = new Date().toISOString().replace('T',' ').slice(0,19);
        if (pIndex >= 0) {
          demoPatients[pIndex].risk = risk;
          demoPatients[pIndex].lastUpdate = now;
        } else {
          demoPatients.push({ id: pid, name, risk, lastUpdate: now, alerts: 0, status: 'Monitor' });
        }
        loadDashboard();
      }, 900); // demo delay
    }

    function clearForm() {
      ['patientId','patientName','patientAge','patientSex','tempManual','hrManual','rrManual','bpManual','spo2Manual','fileInput'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'file') el.value = '';
        else if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
      document.getElementById('result').classList.add('hidden');
      document.getElementById('loading').classList.add('hidden');
    }

    // Alerts engine (demo)
    function loadAlerts() {
      const panel = document.getElementById('alertsPanel');
      panel.innerHTML = '';
      const counts = { emergency: 0, priority: 0, normal: 0 };
      demoAlerts.forEach(a => {
        counts[a.level] += 1;
        const card = document.createElement('div');
        card.className = `alert-card ${a.level}`;
        card.style.marginBottom = '10px';
        card.innerHTML = `<div style="font-weight:700">${a.level.toUpperCase()}</div><div style="color:#666">${a.patient} — ${a.reason}</div><div style="color:#999;font-size:0.85rem">${a.time}</div>`;
        panel.appendChild(card);
      });
      document.getElementById('countEmergency').textContent = counts.emergency;
      document.getElementById('countPriority').textContent = counts.priority;
      document.getElementById('countNormal').textContent = counts.normal;
    }

    function clearAlerts() {
      demoAlerts.length = 0;
      loadAlerts();
      loadDashboard();
    }
  </script>
</body>
</html>
